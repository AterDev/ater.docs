
# 业务实现

## 定义实体模型

## 生成基础代码
使用`droplet api`生成基础的`dto`,`dataStore`,`Controller`等基础代码。

## 实现自定义业务逻辑

在`Manager`中实现自定义业务，通常包括 `筛选查询`,`添加实体`,`更新实体`.

### 筛选查询
构建自定义查询条件的步骤：

1. 使用`GetQueryable`方法获取`IQueryable`对象.
2. 构建自己的`IQueryable`
3. 调用父类`FilterAsync`方法

代码示例：

```csharp
var query = GetQueryable();
if (filter.EnvironmentId != null)
{
    query = query.Where(q => q.Environment.Id == filter.EnvironmentId);
}
query = query.OrderBy(q => q.Sort)
    .OrderBy(q => q.Environment.Name)
    .Include(q => q.Environment)
    .Include(q => q.Resources)!
        .ThenInclude(r => r.Attributes);

 return await base.FilterAsync<TItem>(filter);
```

### 更新实体
`manager`提供了`GetCurrent`方法来获取当前(`可写数据库上下文`)的实体。

在控制器中，会先获取实体，如果不存在，则直接返回`404`。

实体更新的方法传递两个参数，一个是实体本身，一个是提交的`DTO`对象,
实体本身是在控制器当中使用`GetCurrent`方法获取到的，直接作为参数传递过去即可。

代码示例:
```csharp
public override async Task<ResourceTypeDefinition> UpdateAsync(ResourceTypeDefinition entity, ResourceTypeDefinitionUpdateDto dto)
    {
        // 更新关联的内容
        entity!.AttributeDefines = null;
        if (dto.AttributeDefineIds != null)
        {
            // 通过父类的 Stores 查询其他实体的内容
            var attributeDefines = await Stores.ResourceAttributeDefineCommand.Db.Where(a => dto.AttributeDefineIds.Contains(a.Id)).ToListAsync();
            entity.AttributeDefines = attributeDefines;
        }
        return await base.UpdateAsync(entity, dto);
    }
```

### 详情查询
`manager`提供了默认的详情查询方法，可直接传递查询条件.

若自定义查询，如查询关联的内容，需要添加新的方法来实现.

`manager`提供了`Query.Db`成员，可直接进行查询。

代码示例:

```csharp
public async Task<ResourceGroup?> FindAsync(Guid id)
{
    return await Query.Db
        .Include(g => g.Environment)
        .FirstOrDefaultAsync(g => g.Id == id);
}
```